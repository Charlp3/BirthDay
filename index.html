<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>BirthDay v4.4</title>

<style>
:root{
  --bg-main:#fdf8ee;
  --accent:#ffd166;
  --text:#2b1e00;
  --line:rgba(0,0,0,.15);
  --btn-grad-start:#f2c94c;
  --btn-grad-end:#d97706;
  --badge-bg:#fff;
  --badge-border:rgba(0,0,0,.2);
  --banner-live-bg:#FADADD;
  --banner-live-fg:#6B213E;
  --banner-mem-bg:#D8C7E6;
  --banner-mem-fg:#3D2A54;
  --banner-mem-border:#B7A4D4;
  --row-bg:#ffffffcc;
  --row-bg-alt:#fff7e0cc;
  --row-dead:#000000;
  --row-dead-bg:#00000008;
  --chip-bg:#fff3bf;
  --chip-border:#d4b100;
}

/* page */
body{
  margin:0;
  background:var(--bg-main);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  line-height:1.4;
}

/* header */
header{
  position:sticky;
  top:0;
  z-index:50;
  background:var(--accent);
  border-bottom:1px solid var(--line);
  padding:10px;
  display:flex;
  flex-wrap:wrap;
  align-items:flex-start;
  justify-content:space-between;
  gap:8px 12px;
  font-size:15px;
  font-weight:600;
  color:var(--text);
}
header .left,
header .right{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:8px;
}
header .ver{
  font-weight:700;
}
.badgeWhite{
  width:24px;
  height:24px;
  border-radius:50%;
  display:inline-flex;
  justify-content:center;
  align-items:center;
  background:var(--badge-bg);
  border:1px solid var(--badge-border);
  font-size:13px;
  font-weight:700;
  color:var(--text);
  line-height:1;
}
button.btn{
  background:linear-gradient(135deg,var(--btn-grad-start),var(--btn-grad-end));
  border:none;
  border-radius:10px;
  padding:8px 12px;
  font-size:14px;
  font-weight:700;
  color:var(--text);
  box-shadow:0 2px 6px rgba(0,0,0,.2);
}
button.btn:active{
  transform:scale(.97);
}

/* zone banni√®re */
#bannerWrap{
  position:relative;
}
.banner{
  display:none;
  margin:12px auto 0;
  max-width:1100px;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid var(--line);
  box-shadow:0 2px 6px rgba(0,0,0,.1);
  font-size:14px;
  font-weight:600;
  text-align:center;
  line-height:1.4;
}
.banner.live{
  background:var(--banner-live-bg);
  color:var(--banner-live-fg);
  border-color:var(--banner-live-bg);
}
.banner.mem{
  background:var(--banner-mem-bg);
  color:var(--banner-mem-fg);
  border-color:var(--banner-mem-border);
}

/* cartes / tableau principal */
main{
  padding:12px;
  max-width:1100px;
  margin:0 auto;
  font-size:14px;
}
.tableCard{
  background:#fff7d9;
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px;
  box-shadow:0 2px 4px rgba(0,0,0,.08);
}

/* table responsive simple */
.tableWrapper{
  overflow-x:auto;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
  min-width:480px;
}
thead{
  background:#fff0b3;
  position:sticky;
  top:0;
  z-index:5;
}
th{
  text-align:left;
  font-weight:700;
  color:#2b1e00;
  padding:6px 8px;
  white-space:nowrap;
  border-bottom:1px solid var(--line);
  font-size:13px;
}
td{
  padding:6px 8px;
  border-bottom:1px solid rgba(0,0,0,.07);
  vertical-align:top;
  font-size:14px;
  color:var(--text);
}

/* lignes */
tr:nth-child(even){
  background:var(--row-bg);
}
tr:nth-child(odd){
  background:var(--row-bg-alt);
}
tr.dead td{
  color:var(--row-dead);
  background:var(--row-dead-bg);
}

/* type ic√¥nes */
.typeCell{
  text-align:center;
  font-size:16px;
}

/* mini puce sombre pour ceux d√©c√©d√©s dans le nom */
.nameCell .chipDead{
  background:#000;
  color:#fff;
  border-radius:6px;
  padding:1px 4px;
  font-size:11px;
  font-weight:600;
  margin-left:4px;
}
.nameCell .chipDog{
  background:var(--chip-bg);
  border:1px solid var(--chip-border);
  border-radius:6px;
  padding:1px 4px;
  font-size:11px;
  font-weight:600;
  margin-left:4px;
  color:#5a4800;
}

/* section param√®tres / import */
.settingsCard{
  margin-top:16px;
  background:#fff;
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px;
  box-shadow:0 2px 4px rgba(0,0,0,.06);
  font-size:14px;
}
.settingsCard h2{
  font-size:15px;
  margin:0 0 8px 0;
  color:#2b1e00;
}
.settingsRow{
  display:flex;
  flex-direction:column;
  margin-bottom:10px;
  font-size:14px;
}
.settingsRow label{
  font-weight:600;
  margin-bottom:4px;
  color:#2b1e00;
}
.settingsRow input[type="file"]{
  font-size:14px;
}

/* confettis cartes (tombe devant tout) */
.faller{
  position:fixed;
  z-index:9999;
  will-change:transform,opacity;
  pointer-events:none;
  user-select:none;
  font-size:24px;
  line-height:1;
}
</style>
</head>
<body>

<header>
  <div class="left">
    <div><strong>BirthDay <span class="ver">v4.4</span></strong></div>
    <div id="todayTxt" style="font-size:13px;font-weight:500;"></div>
  </div>
  <div class="right">
    <span class="badgeWhite" id="humBadge" title="Humains">0</span>
    <span class="badgeWhite" id="dogBadge" title="Chiens">0</span>
    <button class="btn" id="testConfetti">Tester</button>
    <button class="btn" id="exportCsvBtn">Sauvegarder CSV</button>
  </div>
</header>

<div id="bannerWrap">
  <div id="banner" class="banner"></div>
</div>

<main>
  <!-- Tableau principal -->
  <section class="tableCard">
    <div class="tableWrapper">
      <table>
        <thead>
          <tr>
            <th>Nom</th>
            <th>Type</th>
            <th>Naissance</th>
            <th>√Çge</th>
            <th>D√©c√®s</th>
            <th>√Çge au d√©c√®s</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- lignes g√©n√©r√©es en JS -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- Param√®tres / Import -->
  <section class="settingsCard">
    <h2>Param√®tres / Importation</h2>
    <div class="settingsRow">
      <label for="importCsvInput">Importer une sauvegarde CSV BirthDay :</label>
      <input type="file" id="importCsvInput" accept=".csv,text/csv">
    </div>
    <div class="settingsRow" style="font-size:12px;color:#555;">
      Format attendu :<br/>
      Nom;Type;Naissance;D√©c√©d√©;D√©c√®s;Notes<br/>
      Dates en JJ/MM/AAAA<br/>
      D√©c√©d√© = Oui / Non
    </div>
  </section>
</main>

<script>
/* ========= Donn√©es & stockage ========= */

const STORE_KEY = 'birthday_famille_v1';

// charge les donn√©es stock√©es
function loadData(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return [];
    return JSON.parse(raw);
  }catch(e){
    console.warn('loadData error',e);
    return [];
  }
}

// sauve les donn√©es
function saveData(arr){
  try{
    localStorage.setItem(STORE_KEY, JSON.stringify(arr));
  }catch(e){
    console.warn('saveData error',e);
  }
}

/* ========= Helpers dates & formats ========= */

// convertit "2025-10-28" ou "2025-10-28T..." -> Date
function toDateObj(iso){
  if(!iso) return null;
  const d = new Date(iso);
  if(isNaN(d)) return null;
  return d;
}

// renvoie JJ/MM/AAAA lisible
function fmtDateFr(d){
  if(!d) return '';
  // si d√©j√† JJ/MM/AAAA
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(d)) return d;
  const obj = new Date(d);
  if(isNaN(obj)) return '';
  const j = String(obj.getDate()).padStart(2,'0');
  const m = String(obj.getMonth()+1).padStart(2,'0');
  const a = obj.getFullYear();
  return `${j}/${m}/${a}`;
}

// calcule √¢ge actuel ou √¢ge √† une date
function ageAt(birthISO, refISO){
  const b = toDateObj(birthISO);
  if(!b) return '';
  const ref = refISO ? toDateObj(refISO) : new Date();
  if(!ref) return '';
  let y = ref.getFullYear() - b.getFullYear();
  const mDiff = ref.getMonth() - b.getMonth();
  const dDiff = ref.getDate() - b.getDate();
  if(mDiff < 0 || (mDiff === 0 && dDiff < 0)){
    y--;
  }
  return y<0 ? '' : y;
}

/* ========= Confettis style cartes ========= */

function confetti(){
  const n=20;
  const symbols=['‚ô†Ô∏è','‚ô•Ô∏è','‚ô¶Ô∏è','‚ô£Ô∏è'];
  for(let i=0;i<n;i++){
    const el=document.createElement('div');
    el.className='faller';
    el.textContent=symbols[Math.floor(Math.random()*symbols.length)];
    el.style.left=(Math.random()*100)+'vw';
    el.style.top=(Math.random()*-300)+'px';
    el.style.fontSize=(20+Math.random()*16)+'px';
    el.style.opacity='0.9';
    document.body.appendChild(el);

    // animation
    const drift=(Math.random()-.5)*400;
    const fall=window.innerHeight+120;
    const spin=(Math.random()-.5)*720;
    const delay=Math.random()*1500;

    setTimeout(()=>{
      el.style.transition='transform 11s linear, opacity 11s linear';
      el.style.transform=`translate(${drift}px,${fall}px) rotate(${spin}deg)`;
      el.style.opacity='0';
    },delay);

    // cleanup
    setTimeout(()=>{el.remove();},12000);
  }
}

/* ========= Banni√®re (f√™te / souvenir) ========= */

function showBannerLive(names){
  const b=document.getElementById('banner');
  b.className='banner live';
  b.innerHTML = `üéâ Joyeux anniversaire : <strong>${names}</strong> !`;
  b.style.display='block';
  confetti();
}

function showBannerMem(names){
  const b=document.getElementById('banner');
  b.className='banner mem';
  b.innerHTML = `üïØÔ∏è Souvenir : <strong>${names}</strong>`;
  b.style.display='block';
}

/* Ici tu pourrais avoir ta d√©tection automatique des anniversaires du jour,
   et appeler showBannerLive(...) ou showBannerMem(...).
   Je laisse la logique automatique telle que tu l‚Äôas dans ta version,
   tu pourras la recoller si besoin.
*/

/* ========= Rendu du tableau principal ========= */

function renderTable(data){
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML='';

  // tri : par prochain anniversaire dans l'ann√©e (ton ordre pr√©f√©r√©)
  // on garde ici un tri simple : par mois+jour de naissance dans l'ann√©e
  const today = new Date();
  const tMonth = today.getMonth()+1;
  const tDay = today.getDate();

  function nextSortKey(p){
    // clef pour classer par anniversaire futur
    const d = toDateObj(p.naissance);
    if(!d) return '9999-99-99';
    const m = d.getMonth()+1;
    const day = d.getDate();
    // si anniversaire d√©j√† pass√© ce mois-ci, on le met "apr√®s"
    const passedThisYear =
      (m < tMonth) ||
      (m === tMonth && day < tDay);

    // on fabrique "0000-MM-JJ" si pas encore pass√©
    // sinon "0001-MM-JJ" pour mettre apr√®s
    const prefix = passedThisYear?'0001':'0000';
    return `${prefix}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
  }

  const sorted = [...data].sort((a,b)=>{
    if(nextSortKey(a) < nextSortKey(b)) return -1;
    if(nextSortKey(a) > nextSortKey(b)) return 1;
    return (a.nom||'').localeCompare(b.nom||'');
  });

  sorted.forEach(p=>{
    const tr=document.createElement('tr');
    if(p.decede) tr.classList.add('dead');

    const tdNom=document.createElement('td');
    tdNom.className='nameCell';
    tdNom.textContent=p.nom||'';
    // petit badge "d√©c√©d√©"
    if(p.decede){
      const chip=document.createElement('span');
      chip.className='chipDead';
      chip.textContent='‚úù';
      tdNom.appendChild(chip);
    }
    // badge chien ?
    if(p.type==='Chien'){
      const chipDog=document.createElement('span');
      chipDog.className='chipDog';
      chipDog.textContent='üêï';
      tdNom.appendChild(chipDog);
    }

    const tdType=document.createElement('td');
    tdType.className='typeCell';
    tdType.textContent = (p.type==='Chien') ? 'üêï' : 'üë§';

    const tdBirth=document.createElement('td');
    tdBirth.textContent = fmtDateFr(p.naissance);

    const tdAge=document.createElement('td');
    tdAge.textContent = ageAt(p.naissance,'');

    const tdDeath=document.createElement('td');
    tdDeath.textContent = p.decede ? fmtDateFr(p.deces) : '';

    const tdAgeDeath=document.createElement('td');
    tdAgeDeath.textContent = p.decede ? ageAt(p.naissance,p.deces) : '';

    const tdNotes=document.createElement('td');
    tdNotes.textContent = p.notes||'';

    tr.appendChild(tdNom);
    tr.appendChild(tdType);
    tr.appendChild(tdBirth);
    tr.appendChild(tdAge);
    tr.appendChild(tdDeath);
    tr.appendChild(tdAgeDeath);
    tr.appendChild(tdNotes);

    tbody.appendChild(tr);
  });
}

/* ========= Badges humains / chiens ========= */

function updateBadges(data){
  let humans=0,dogs=0;
  data.forEach(p=>{
    if(p.type==='Chien') dogs++; else humans++;
  });
  document.getElementById('humBadge').textContent=humans;
  document.getElementById('dogBadge').textContent=dogs;
}

/* ========= EXPORT CSV (sauvegarde manuelle) =========
   Format officiel BirthDay :
   Nom;Type;Naissance;D√©c√©d√©;D√©c√®s;Notes
   Dates en JJ/MM/AAAA
   D√©c√©d√© = Oui / Non
*/
function setupExport(data){
  const btn=document.getElementById('exportCsvBtn');
  if(!btn) return;

  btn.addEventListener('click', ()=>{
    try{
      if(!data.length){
        alert("Aucune donn√©e √† sauvegarder !");
        return;
      }

      function toFr(d){
        if(!d) return '';
        if(/^\d{2}\/\d{2}\/\d{4}$/.test(d)) return d;
        const obj=new Date(d);
        if(isNaN(obj)) return '';
        const j=String(obj.getDate()).padStart(2,'0');
        const m=String(obj.getMonth()+1).padStart(2,'0');
        const a=obj.getFullYear();
        return `${j}/${m}/${a}`;
      }

      const headers=['Nom','Type','Naissance','D√©c√©d√©','D√©c√®s','Notes'];
      const rows=data.map(p=>{
        const Nom=(p.nom||'').replace(/[\r\n;]/g,' ');
        const Type=(p.type||'').replace(/[\r\n;]/g,' ');
        const Naissance=toFr(p.naissance);
        const Decede=p.decede?'Oui':'Non';
        const Deces=p.deces?toFr(p.deces):'';
        const Notes=(p.notes||'').replace(/[\r\n;]/g,' ');
        return [Nom,Type,Naissance,Decede,Deces,Notes].join(';');
      });

      const csvContent=[headers.join(';'),...rows].join('\n');
      const fileName=`BirthDay-${new Date().toISOString().slice(0,10)}.csv`;

      const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=fileName;
      a.target='_blank';
      a.rel='noopener';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      alert("‚úÖ Sauvegarde CSV cr√©√©e !");
    }catch(e){
      console.error(e);
      alert("Erreur pendant la sauvegarde CSV.");
    }
  });
}

/* ========= IMPORT CSV (restauration) =========
   Attend exactement le m√™me format que l'export :
   Nom;Type;Naissance;D√©c√©d√©;D√©c√®s;Notes
   (dates JJ/MM/AAAA)
*/
function setupImport(){
  const input=document.getElementById('importCsvInput');
  if(!input) return;

  input.addEventListener('change', async ev=>{
    const file=ev.target.files&&ev.target.files[0];
    if(!file) return;
    try{
      const text=await file.text();
      const {rows,ignored} = parseBirthDayCsv(text);

      if(!rows.length){
        alert("Import: aucune ligne valide.");
        ev.target.value="";
        return;
      }

      // fusion simple
      const current=loadData();
      const merged=current.concat(rows);
      saveData(merged);

      alert(`Import termin√©. ${rows.length} ajout(s). ${ignored} ignor√©e(s).`);

      // rerender
      renderAll();
    }catch(e){
      console.error(e);
      alert("Erreur pendant l'import CSV.");
    }
    ev.target.value=""; // reset input
  });
}

// transforme JJ/MM/AAAA (ou JJ-MM-AAAA) -> "YYYY-MM-DD"
function toISOFromFr(d){
  if(!d) return '';
  // d√©j√† ISO ?
  if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
  const m=d.trim().match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
  if(m){
    const j=m[1].padStart(2,'0');
    const mo=m[2].padStart(2,'0');
    const a=m[3];
    return `${a}-${mo}-${j}`;
  }
  const obj=new Date(d);
  if(!isNaN(obj)){
    const j=String(obj.getDate()).padStart(2,'0');
    const mo=String(obj.getMonth()+1).padStart(2,'0');
    const a=obj.getFullYear();
    return `${a}-${mo}-${j}`;
  }
  return '';
}

// parse le CSV BirthDay officiel
function parseBirthDayCsv(csvText){
  const lines=csvText.split(/\r?\n/).filter(l=>l.trim()!=='');
  if(!lines.length) return {rows:[],ignored:0};

  const header=lines[0].split(';').map(h=>h.trim().toLowerCase());

  const idxNom      = header.indexOf('nom');
  const idxType     = header.indexOf('type');
  const idxNais     = header.indexOf('naissance');
  const idxDecede   = header.indexOf('d√©c√©d√©');
  const idxDeces    = header.indexOf('d√©c√®s');
  const idxNotes    = header.indexOf('notes');

  if(idxNom<0||idxType<0||idxNais<0||idxDecede<0||idxDeces<0||idxNotes<0){
    return {rows:[],ignored:lines.length-1};
  }

  const out=[];
  let ignored=0;

  for(let i=1;i<lines.length;i++){
    const cols=lines[i].split(';');

    const Nom=(cols[idxNom]||'').trim();
    const Type=(cols[idxType]||'').trim();
    const Nais=(cols[idxNais]||'').trim();
    const Decede=(cols[idxDecede]||'').trim();
    const Deces=(cols[idxDeces]||'').trim();
    const Notes=(cols[idxNotes]||'').trim();

    const isoBirth=toISOFromFr(Nais);
    if(!isoBirth){
      ignored++;
      continue;
    }
    const isoDeces=toISOFromFr(Deces);

    out.push({
      nom:Nom,
      type:Type,
      naissance:isoBirth,
      decede:/^oui$/i.test(Decede),
      deces:isoDeces||'',
      notes:Notes
    });
  }

  return {rows:out,ignored};
}

/* ========= Rendu global ========= */

function renderAll(){
  const data = loadData();
  renderTable(data);
  updateBadges(data);

  // date du jour
  const today = new Date();
  const dayStr = String(today.getDate()).padStart(2,'0');
  const moStr  = String(today.getMonth()+1).padStart(2,'0');
  const yrStr  = today.getFullYear();
  document.getElementById('todayTxt').textContent = `${dayStr}-${moStr}-${yrStr}`;
}

/* ========= Init ========= */

function init(){
  // affichage principal
  renderAll();

  // bouton confettis test
  const testBtn=document.getElementById('testConfetti');
  if(testBtn){
    testBtn.addEventListener('click',()=>{
      confetti();
      showBannerLive("Test");
    });
  }

  // exporter CSV
  setupExport(loadData());

  // importer CSV
  setupImport();
}

init();
</script>

</body>
</html>